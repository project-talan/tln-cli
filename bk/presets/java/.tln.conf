const path = require('path');

module.exports = {
  tags: (tln) => [],
  options: (tln, options) => {},
  dotenvs: (tln) => [],
  depends: (tln) => [],
  inherits: (tln) => [],
  variables: (tln, variables) => {
    variables
      .set('JAVA_HOME', (tln, data) => data.env['COMPONENT_ORIGIN'])
      .prepend('PATH', (tln, data) => `${data.env['COMPONENT_ORIGIN']}${data.sep}bin`);
  },
  steps: (tln) => [
    {
      id: 'generate-jersey-grizzly2',
      desc: '',
      script: (tln, script) => script.set([
        'mvn archetype:generate \\',
        '    -DarchetypeArtifactId=jersey-quickstart-grizzly2 \\',
        '    -DarchetypeGroupId=org.glassfish.jersey.archetypes \\',
        '    -DinteractiveMode=false \\',
        '    -DgroupId=${COMPONENT_GROUP_ID} \\',
        '    -DartifactId=${COMPONENT_ARTIFACT_ID} \\',
        '    -Dpackage=${COMPONENT_ID} \\',
        '    -Dversion=${COMPONENT_VERSION} \\',
        '    -DarchetypeVersion=2.28',
        'mv ${COMPONENT_ARTIFACT_ID}/* ./',
        'rmdir ${COMPONENT_ARTIFACT_ID}'
      ])
    },
    {
      id: 'build',
      desc: '',
      script: (tln, script) => script.set([
        'mvn clean install'
      ])
    },
    {
      id: 'serve',
      desc: '',
      script: (tln, script) => script.set([
        'java -jar ./target/${COMPONENT_ID}-${COMPONENT_VERSION}-jar-with-dependencies.jar'
      ])
    },
    {
      id: 'serve-mvn',
      desc: '',
      script: (tln, script) => script.set([
        'mvn exec:java'
      ])
    },
    {
      id: 'build-docker',
      desc: '',
      script: (tln, script) => script.set([
        'docker build --tag ${COMPONENT_ID}:${COMPONENT_VERSION} .'
      ])
    },
    {
      id: 'run-docker',
      desc: '',
      script: (tln, script) => script.set([
        'docker run --rm -d -p ${COMPONENT_PARAM_PORT}:${COMPONENT_PARAM_PORT} -p ${COMPONENT_PARAM_PORTS}:${COMPONENT_PARAM_PORTS} --name ${COMPONENT_ID} ${COMPONENT_ID}:${COMPONENT_VERSION}'
      ])
    },
    {
      id: 'install',
      filter: '',
      script: (tln, script) => {
        if (tln.utils.canInstallComponent(tln, script, 'java')) {
          const id = script.env["COMPONENT_ID"];
          //
          defaultDistrs = {
            'default-jre': {
              'ubuntu': ['sudo apt-get install -y default-jre'],
              'centos': ['sudo yum install -y java-jre']
            },
            'default-jdk': {
              'ubuntu': ['sudo apt-get install -y default-jdk'],
              'centos': ['sudo yum install -y java-sdk']
            }
          };

          if (!tln.utils.getDefaultScript(tln, id, defaultDistrs, script)) {
            script.set(tln.utils.getDownloadScriptById(tln, id, {
              'openjdk-9.0.4': {
                'linux': {
                  name: 'openjdk-9.0.4_linux-x64_bin.tar.gz',
                  opts: { src: 'jdk-9.0.4', flt: '*', dest: '.', rmv: 'jdk-9.0.4' },
                  url: 'https://download.java.net/java/GA/jdk9/9.0.4/binaries/openjdk-9.0.4_linux-x64_bin.tar.gz'
                },
                'darwin': {
                  name: 'openjdk-9.0.4_osx-x64_bin.tar.gz',
                  opts: { src: 'jdk-9.0.4.jdk/Contents/Home', flt: '*', dest: '.', rmv: 'jdk-9.0.4.jdk' },
                  url: 'https://download.java.net/java/GA/jdk9/9.0.4/binaries/openjdk-9.0.4_osx-x64_bin.tar.gz'
                },
                'win32': {
                  name: 'openjdk-9.0.4_windows-x64_bin.tar.gz',
                  opts: { src: 'jdk-9.0.4', flt: '*', dest: '.', rmv: 'jdk-9.0.4' },
                  url: 'https://download.java.net/java/GA/jdk9/9.0.4/binaries/openjdk-9.0.4_windows-x64_bin.tar.gz'
                }
              },
              'openjdk-10.0.2': {
                'linux': {
                  name: 'openjdk-10.0.2_linux-x64_bin.tar.gz',
                  opts: { src: 'jdk-10.0.2', flt: '*', dest: '.', rmv: 'jdk-10.0.2' },
                  url: 'https://download.java.net/java/GA/jdk10/10.0.2/19aef61b38124481863b1413dce1855f/13/openjdk-10.0.2_linux-x64_bin.tar.gz'
                },
                'darwin': {
                  name: 'openjdk-10.0.2_osx-x64_bin.tar.gz',
                  opts: { src: 'jdk-10.0.2.jdk/Contents/Home', flt: '*', dest: '.', rmv: 'jdk-10.0.2.jdk' },
                  url: 'https://download.java.net/java/GA/jdk10/10.0.2/19aef61b38124481863b1413dce1855f/13/openjdk-10.0.2_osx-x64_bin.tar.gz'
                },
                'win32': {
                  name: 'openjdk-10.0.2_windows-x64_bin.tar.gz',
                  opts: { src: 'jdk-10.0.2', flt: '*', dest: '.', rmv: 'jdk-10.0.2' },
                  url: 'https://download.java.net/java/GA/jdk10/10.0.2/19aef61b38124481863b1413dce1855f/13/openjdk-10.0.2_windows-x64_bin.tar.gz'
                }
              },
              'openjdk-11.0.2': {
                'linux': {
                  name: 'openjdk-11.0.2_linux-x64_bin.tar.gz',
                  opts: { src: 'jdk-11.0.2', flt: '*', dest: '.', rmv: 'jdk-11.0.2' },
                  url: 'https://download.java.net/java/GA/jdk11/9/GPL/openjdk-11.0.2_linux-x64_bin.tar.gz'
                },
                'darwin': {
                  name: 'openjdk-11.0.2_osx-x64_bin.tar.gz',
                  opts: { src: 'jdk-11.0.2.jdk/Contents/Home', flt: '*', dest: '.', rmv: 'jdk-11.0.2.jdk' },
                  url: 'https://download.java.net/java/GA/jdk11/9/GPL/openjdk-11.0.2_osx-x64_bin.tar.gz'
                },
                'win32': {
                  name: 'openjdk-11.0.2_windows-x64_bin.zip',
                  opts: { src: 'jdk-11.0.2', flt: '*', dest: '.', rmv: 'jdk-11.0.2' },
                  url: 'https://download.java.net/java/GA/jdk11/9/GPL/openjdk-11.0.2_windows-x64_bin.zip'
                }
              },
              'openjdk-12.0.2': {
                'linux': {
                  name: 'openjdk-12.0.2_linux-x64_bin.tar.gz',
                  opts: { src: 'jdk-12.0.2', flt: '*', dest: '.', rmv: 'jdk-12.0.2' },
                  url: 'https://download.java.net/java/GA/jdk12.0.2/e482c34c86bd4bf8b56c0b35558996b9/10/GPL/openjdk-12.0.2_linux-x64_bin.tar.gz'
                },
                'darwin': {
                  name: 'openjdk-12.0.2_osx-x64_bin.tar.gz',
                  opts: { src: 'jdk-12.0.2.jdk/Contents/Home', flt: '*', dest: '.', rmv: 'jdk-12.0.2.jdk' },
                  url: 'https://download.java.net/java/GA/jdk12.0.2/e482c34c86bd4bf8b56c0b35558996b9/10/GPL/openjdk-12.0.2_osx-x64_bin.tar.gz'
                },
                'win32': {
                  name: 'openjdk-12.0.2_windows-x64_bin.zip', 
                  opts: { src: 'jdk-12.0.2', flt: '*', dest: '.', rmv: 'jdk-12.0.2' },
                  url: 'https://download.java.net/java/GA/jdk12.0.2/e482c34c86bd4bf8b56c0b35558996b9/10/GPL/openjdk-12.0.2_windows-x64_bin.zip'
                }
              },
              'openjdk-13': {
                'linux': {
                  name: 'openjdk-13_linux-x64_bin.tar.gz',
                  opts: { src: 'jdk-13', flt: '*', dest: '.', rmv: 'jdk-13' },
                  url: 'https://download.java.net/java/GA/jdk13/5b8a42f3905b406298b72d750b6919f6/33/GPL/openjdk-13_linux-x64_bin.tar.gz'
                },
                'darwin': {
                  name: 'openjdk-13_osx-x64_bin.tar.gz',
                  opts: { src: 'jdk-13.jdk/Contents/Home', flt: '*', dest: '.', rmv: 'jdk-13.jdk' },
                  url: 'https://download.java.net/java/GA/jdk13/5b8a42f3905b406298b72d750b6919f6/33/GPL/openjdk-13_osx-x64_bin.tar.gz'
                },
                'win32': {
                  name: 'openjdk-13_windows-x64_bin.zip',
                  opts: { src: 'jdk-13', flt: '*', dest: '.', rmv: 'jdk-13' },
                  url: 'https://download.java.net/java/GA/jdk13/5b8a42f3905b406298b72d750b6919f6/33/GPL/openjdk-13_windows-x64_bin.zip'
                }
              }
            }));
          }
        }
      }
    }
  ],
  components: (tln) => [
    { id: 'default-jre' },
    { id: 'default-jdk' },
    { id: 'openjdk-9.0.4' },
    { id: 'openjdk-10.0.2' },
    { id: 'openjdk-11.0.2' },
    { id: 'openjdk-12.0.2' },
    { id: 'openjdk-13' }
  ]
}